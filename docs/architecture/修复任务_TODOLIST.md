# 🎵 电台模块修复任务TODOLIST

## 📋 问题总结

我已经完成了**一行一行的深度代码检查**，并在大脑里**完整模拟运行了整个程序**，发现了以下关键问题：

#### ⚠️ 发现的关键问题

1. **事件发射接口错误**（最高优先级）
   - 使用了不存在的 `UnifiedEventBus.emit()` 方法
   - 需要修复为正确的事件发射接口

2. **事件类型匹配问题**（高优先级）
   - 事件监听器期望的数据结构与发射的事件不匹配
   - 可能导致播放状态同步失败

3. **API端点验证**（中优先级）
   - 硬编码的API端点可能在后端不存在
   - 需要确认实际可用的API接口

4. **测试数据路径**（低优先级）
   - 硬编码的本地路径在不同系统上可能不存在
   - 测试模式下音频文件无法加载

## 🔧 修复TODOLIST

### 第一阶段：事件系统修复（最高优先级）

- [ ] **修复事件发射接口错误**
  - [ ] 将 `UnifiedEventBus.emit()` 改为 `UnifiedEventBus.emitPlayback()`
  - [ ] 将 `UnifiedEventBus.emitTransition()` 改为正确的过渡事件发射
  - [ ] 确保事件数据结构与监听器期望一致

- [ ] **修复事件类型匹配问题**
  - [ ] 统一播放状态事件的数据结构
  - [ ] 确保 `playbackState` 字段在所有事件中一致
  - [ ] 修复事件监听器的类型定义

### 第二阶段：API集成修复（高优先级）

- [ ] **验证API端点可用性**
  - [ ] 检查 `/api/music/playlist` 是否存在
  - [ ] 检查 `/api/music/status` 是否存在
  - [ ] 检查 `/api/music/play` 是否存在
  - [ ] 检查 `/api/music/pause` 是否存在
  - [ ] 检查 `/api/music/next` 是否存在
  - [ ] 检查 `/api/music/previous` 是否存在
  - [ ] 检查 `/api/music/volume` 是否存在

- [ ] **创建缺失的API端点**
  - [ ] 在 `metadata_server.js` 中添加音乐API路由
  - [ ] 实现播放列表获取接口
  - [ ] 实现播放状态管理接口
  - [ ] 实现播放控制接口
  - [ ] 实现音量控制接口

### 第三阶段：测试数据优化（中优先级）

- [ ] **修复测试音频文件路径**
  - [ ] 使用相对路径替代硬编码的绝对路径
  - [ ] 创建通用的测试音频文件加载机制
  - [ ] 添加音频文件存在性检查

- [ ] **优化测试模式**
  - [ ] 实现动态音频文件发现
  - [ ] 添加音频文件格式验证
  - [ ] 实现音频文件元数据提取

### 第四阶段：错误处理和容错（中优先级）

- [ ] **增强错误处理**
  - [ ] 添加API调用失败的重试机制
  - [ ] 实现优雅的降级处理
  - [ ] 添加用户友好的错误提示

- [ ] **改进状态管理**
  - [ ] 实现播放状态的本地缓存
  - [ ] 添加网络状态检测
  - [ ] 实现离线模式支持

### 第五阶段：性能优化（低优先级）

- [ ] **优化音频加载**
  - [ ] 实现音频文件的预加载机制
  - [ ] 添加音频流式加载支持
  - [ ] 优化内存使用

- [ ] **改进用户体验**
  - [ ] 添加加载状态指示器
  - [ ] 实现平滑的播放过渡
  - [ ] 优化响应式设计

## 🎯 立即执行计划

#### 第一步：修复事件系统（立即执行）
1. 修复 `UnifiedEventBus.emit()` 调用
2. 统一事件数据结构
3. 测试事件系统集成

#### 第二步：验证API端点（立即执行）
1. 检查现有API实现
2. 创建缺失的API端点
3. 测试API集成

#### 第三步：优化测试数据（后续执行）
1. 修复硬编码路径
2. 实现动态文件发现
3. 测试音频加载

## 📊 预期结果

修复完成后，电台组件将能够：
- ✅ 正确发射和接收事件
- ✅ 与V2版本事件系统完全集成
- ✅ 通过API获取音频数据
- ✅ 在测试模式下正常加载音频文件
- ✅ 提供稳定的播放体验

## 🔄 模块化重构计划

### 重构目标
- 将复杂的电台模块拆分为多个独立模块
- 避免代码耦合，提高可维护性
- 简化组件逻辑，专注于核心功能

### 模块划分
1. **RadioCore** - 核心播放逻辑
2. **RadioUI** - 用户界面组件
3. **RadioEvents** - 事件处理
4. **RadioAPI** - API接口封装
5. **RadioState** - 状态管理

## 📝 更新记录

- **2025-01-25** - 创建修复任务TODOLIST
- **2025-01-25** - 发现关键问题并制定修复计划
- **2025-01-25** - 计划模块化重构

---
**状态**: 进行中
**优先级**: 高
**负责人**: AI助手
**预计完成时间**: 2025-01-26
