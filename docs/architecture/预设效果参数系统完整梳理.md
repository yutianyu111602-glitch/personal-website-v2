# 🎨 预设效果参数系统完整梳理文档

## 📋 文档概述

**目标**: 完全梳理现有预设、效果和参数系统，理清路由和参数关系
**范围**: 涵盖LiquidMetal、UniverseEntropy、Techno预设、情绪系统等所有相关模块
**架构**: 基于现有代码深度分析，整理成清晰的系统架构图

---

## 🏗️ 系统架构总览

### 🔄 核心数据流
```
情绪核心 → 随机算法 → 预设选择 → 效果渲染 → 视觉输出
    ↓           ↓         ↓         ↓         ↓
EmotionCore → RandomState → Preset → Effect → Renderer
    ↓           ↓         ↓         ↓         ↓
事件总线 → 状态管理 → 标签匹配 → 节点编排 → WebGL渲染
```

### 🎯 系统层次结构
1. **情绪层**: EmotionCoreManager - 统一情绪管理
2. **算法层**: RandomStateManager - 智能随机性控制
3. **预设层**: LiquidMetalPresets + TechnoPresets - 60+预设系统
4. **效果层**: BlendPipeline + EffectNodes - 渲染节点编排
5. **渲染层**: WebGL渲染器 - 最终视觉输出

---

## 🎲 预设系统架构

### 📊 LiquidMetal预设系统 (60+预设)

#### 🔧 预设标签结构
```typescript
interface Preset {
  id: string;
  tags: {
    // 核心属性
    metalScore: number;      // 0..1 银色契合度
    energyBias: number;      // -1..+1 能量偏置
    valenceBias: number;     // -1..+1 效价偏置
    arousalBias: number;     // 0..1 激活偏置
    
    // 视觉效果
    hueShiftRisk: number;    // 0..1 色偏风险
    specularBoost: number;   // 0..1 高光强化
    rippleAffinity: number;  // 0..1 流动亲和
    
    // 性能控制
    cost: number;            // 1..5 性能代价
    
    // 扩展属性
    flowAffinity?: number;   // 0..1 对流场喜好
    organicAffinity?: number;// 0..1 有机图样喜好
    fractureAffinity?: number;// 0..1 碎裂效果喜好
  };
}
```

#### 🎨 预设分类体系
1. **基础银色预设** (metalScore: 0.8-1.0)
   - `liquid_metal_polish` - 高光银色
   - `liquid_metal_carve` - 雕刻银色
   - `liquid_metal_flow` - 流动银色

2. **高能预设** (energyBias: 0.5-1.0)
   - `high_energy_blast` - 高能爆炸
   - `rhythmic_pulse` - 节奏脉冲

3. **情绪预设** (基于valence/arousal)
   - `calm_reflection` - 平静反射
   - `gentle_ripple` - 温柔涟漪
   - `organic_growth` - 有机生长

4. **技术预设** (特殊效果)
   - `reaction_diffusion` - 反应扩散
   - `crystalline_break` - 晶体破碎
   - `worley_cells` - Worley细胞

### 🎵 Techno预设系统 (5套核心预设)

#### 🎯 预设配置结构
```typescript
interface TechnoPreset {
  limits: {
    bpmSoftLo: number;      // BPM下限
    bpmSoftHi: number;      // BPM上限
    bpmIdeal: number;       // 理想BPM
    bpmTol: number;         // BPM容差
    maxStretchPct: number;  // 最大拉伸百分比
  };
  transition: {
    technoCrossfadeBeats: number; // 交叉淡入淡出拍数
  };
  weights: {
    vocal?: number;         // 人声权重
    energy?: number;        // 能量权重
    tempo?: number;         // 速度权重
    phrase?: number;        // 短语权重
  };
}
```

#### 🎵 预设详细配置
1. **deep_minimal** (122-126 BPM)
   - 32拍长层叠，低人声，平滑能量
   - 适合深夜/极简风格

2. **classic** (126-130 BPM)
   - 24拍crossfade + 低频交接
   - 万能稳态，默认推荐

3. **peak_warehouse** (128-134 BPM)
   - 短语边界切换，能量推进
   - 适合高峰时段

4. **hard_techno** (140-150 BPM)
   - 8-12拍，bass kill→swap
   - 冲击/快速风格

5. **hypnotic** (130-134 BPM)
   - 32拍超长层叠，纹理流动
   - 催眠/流动风格

---

## 🎭 效果系统架构

### 🔄 BlendPipeline渲染管线

#### 📊 节点类型定义
```typescript
type BlendID = 
  | 'LumaSoftOverlay' | 'SMix' | 'BoundedDodge' | 'SoftBurn'
  | 'GrainMerge' | 'StructureMix' | 'BloomHL' | 'EdgeTint'
  | 'DualCurve' | 'TemporalTrail' | 'SpecularGrad' | 'OkLabLightness';

interface BlendNode {
  id: BlendID;
  weight: number;                     // 0..0.22（系统限幅）
  uniforms?: Record<string, number>;  // Shader参数
  category?: 'Base'|'Accent'|'Decor'; // 节点分类
}
```

#### 🎯 节点分类策略
1. **Base节点** (基础层)
   - `LumaSoftOverlay` - 亮度软叠加
   - `SMix` - 简单混合
   - `OkLabLightness` - 亮度控制

2. **Accent节点** (强调层)
   - `BoundedDodge` - 有界闪避
   - `SoftBurn` - 软燃烧
   - `StructureMix` - 结构混合
   - `DualCurve` - 双曲线
   - `SpecularGrad` - 高光渐变

3. **Decor节点** (装饰层)
   - `GrainMerge` - 颗粒合并
   - `BloomHL` - 高光绽放
   - `EdgeTint` - 边缘着色
   - `TemporalTrail` - 时间轨迹

#### 🔧 渲染管线配置
```typescript
interface BlendPipeline {
  nodes: BlendNode[];     // 节点顺序即链路顺序
  ttlMs: number;          // 有效时长，到点重编排
  presetId?: string;      // 关联的预设ID
  extras?: Extras;        // 可选生成器/蒙版
}
```

### 🎨 效果生成器系统

#### 🌊 流动效果 (Flow Effects)
```typescript
interface FlowExtras {
  id: 'CurlNoise' | 'StableFluid' | 'DomainWarp';
  intensity: number;
  speed: number;
  complexity: number;
}
```

#### 🧬 有机效果 (Organic Effects)
```typescript
interface OrganicExtras {
  id: 'Lenia' | 'ReactionDiffusion' | 'CellularAutomata';
  growthRate: number;
  mutationRate: number;
  patternComplexity: number;
}
```

#### 💥 碎裂效果 (Fracture Effects)
```typescript
interface FractureExtras {
  id: 'Worley' | 'Voronoi' | 'FractalNoise';
  cellSize: number;
  distortion: number;
  edgeSharpness: number;
}
```

---

## 🚀 路由系统架构

### 🔌 事件总线路由

#### 📡 跨命名空间路由
```typescript
// 可视化 ↔ 混音 路由
'visualization:preset' → ['automix:energy']
'automix:energy' → ['visualization:effect']

// LiquidMetal ↔ 可视化 路由
'liquidmetal:mood' → ['visualization:preset', 'visualization:color']
'visualization:preset' → ['liquidmetal:pipeline']

// 全局性能事件路由
'global:performance' → ['visualization:effect', 'liquidmetal:pipeline']
```

#### 🎯 事件类型定义
```typescript
type EventNamespace = 
  | 'global'           // 全局事件
  | 'emotion'          // 情绪事件
  | 'visualization'    // 可视化事件
  | 'liquidmetal'      // LiquidMetal事件
  | 'automix'          // 自动混音事件
  | 'random_emotion'   // 随机情绪事件
  | 'performance'      // 性能事件
  | 'recovery';        // 恢复事件
```

#### 📊 核心事件类型
1. **情绪事件**
   - `emotion:change` - 情绪变化
   - `emotion:randomness_update` - 随机性更新

2. **可视化事件**
   - `visualization:preset` - 预设切换
   - `visualization:effect` - 效果更新
   - `visualization:color` - 颜色变化

3. **LiquidMetal事件**
   - `liquidmetal:mood` - 情绪状态
   - `liquidmetal:pipeline` - 渲染管线

4. **随机事件**
   - `random:seed_changed` - 种子变化
   - `random_emotion:integration_ready` - 集成就绪

### 🔄 数据流路由

#### 📊 情绪→随机性路由
```
EmotionCoreManager → RandomStateManager → RandomnessControl
       ↓                    ↓                    ↓
   E/V/A三元情绪 → 情绪映射算法 → 随机性参数调整
```

#### 🎨 随机性→预设路由
```
RandomStateManager → PresetRecommendation → PresetSelection
       ↓                    ↓                    ↓
   随机性控制 → 预设推荐算法 → 预设标签匹配
```

#### 🎭 预设→效果路由
```
PresetSelection → BlendPipeline → EffectNodes → WebGLRenderer
       ↓              ↓              ↓            ↓
   预设标签 → 节点权重计算 → 节点编排 → 最终渲染
```

---

## ⚙️ 参数系统架构

### 🎛️ 随机性控制参数

#### 🔧 RandomnessControl接口
```typescript
interface RandomnessControl {
  baseRandomness: number;    // 基础随机性 (0-1)
  emotionBias: number;       // 情绪偏置 (0-1)
  energyBias: number;        // 能量偏置 (0-1)
  timeBias: number;          // 时间偏置 (0-1)
  contrastBias: number;      // 对比度偏置 (0-1)
}
```

#### 🎯 情绪映射参数
```typescript
interface EmotionRandomnessMapping {
  energy: {
    low: { randomness: number; entropy: number; presetBias: string[] };
    medium: { randomness: number; entropy: number; presetBias: string[] };
    high: { randomness: number; entropy: number; presetBias: string[] };
  };
  valence: {
    negative: { randomness: number; entropy: number; presetBias: string[] };
    neutral: { randomness: number; entropy: number; presetBias: string[] };
    positive: { randomness: number; entropy: number; presetBias: string[] };
  };
  arousal: {
    low: { randomness: number; entropy: number; presetBias: string[] };
    medium: { randomness: number; entropy: number; presetBias: string[] };
    high: { randomness: number; entropy: number; presetBias: string[] };
  };
}
```

### 🎨 渲染参数系统

#### 📊 Uniform参数映射
```typescript
interface UniformParams {
  // 全局参数
  global: {
    iResolution: [number, number];    // 分辨率
    iTime: number;                    // 时间
    iMouse: [number, number];        // 鼠标位置
    uEnergy: number;                  // 能量
    uValence: number;                 // 效价
    uArousal: number;                 // 激活
    uPresetId: number;                // 预设ID
  };
  
  // 节点级参数
  nodes: Record<string, {
    weight: number;                   // 权重
    blendMode: string;                // 混合模式
    opacity: number;                  // 透明度
    scale: number;                    // 缩放
    rotation: number;                 // 旋转
  }>;
}
```

#### 🎭 效果参数控制
```typescript
interface EffectParams {
  // 基础效果
  base: {
    brightness: number;               // 亮度
    contrast: number;                 // 对比度
    saturation: number;               // 饱和度
    hue: number;                      // 色相
  };
  
  // 高级效果
  advanced: {
    blur: number;                     // 模糊
    sharpen: number;                  // 锐化
    noise: number;                    // 噪点
    distortion: number;               // 扭曲
  };
  
  // 动画效果
  animation: {
    speed: number;                    // 速度
    amplitude: number;                // 振幅
    frequency: number;                // 频率
    phase: number;                    // 相位
  };
}
```

---

## 🔧 配置系统架构

### 📁 配置文件结构

#### 🎯 data-config.json
```json
{
  "visualizer": {
    "overlay": {
      "blendMode": "screen",
      "opacity": 0.85,
      "highFps": true
    }
  },
  "layout": {
    "focus": {
      "organizer": { "width": 560, "height": 72 },
      "taskLogger": { "width": 224 }
    }
  },
  "featureFlags": {
    "emotionCoreUnifiedLoop": true,
    "enableTechniqueBridge": true
  },
  "emotionCore": {
    "tickIntervalMs": 500,
    "enableTechniqueBridge": true,
    "conservativeDropout": 0.05
  },
  "aidjMix": {
    "enableTechniqueBridge": true,
    "enableRouterAdapter": false,
    "enableNowPlayingMirror": true,
    "routerConfig": {
      "ENDPOINT_NEXT": "/api/music/next",
      "ENDPOINT_PREV": "/api/music/previous",
      "ENDPOINT_CROSSF": "/api/music/crossfade?duration={ms}",
      "ENDPOINT_VOLUME": "/api/music/volume?level={v}",
      "DEFAULT_CROSSFADE_MS": 4000,
      "SAFETY_RATE_LIMIT_MS": 1200
    },
    "mirrorConfig": {
      "NOWPLAYING_URL": "/api/nowplaying",
      "INTERVAL_MS": 2000
    }
  }
}
```

#### 🌍 环境变量配置
```typescript
// Vite环境变量
VITE_MUSIC_BASE_URL: string;         // 音乐服务基础地址
VITE_BUS_SYNC_ENABLED: boolean;      // 事件总线跨窗口同步
VITE_EMOTION_THEME_ENABLED: boolean; // 情绪主题与效果管理器
VITE_AUTOPILOT_ENABLED: boolean;     // 无人化编排开关
VITE_TERMUSIC_PORT: number;          // Termusic代理端口

// 服务端环境变量
PORT: number;                         // 本地音乐服务器端口
MUSIC_DIR: string;                    // 音乐根目录
PLAYLIST_FILE: string;                // 歌单文件路径
```

### 🎛️ 运行时配置

#### 🔧 事件总线配置
```typescript
interface EventBusConfig {
  enableLogging: boolean;             // 启用日志
  maxListeners: number;               // 最大监听器数量
  eventHistorySize: number;           // 事件历史大小
  enableCrossNamespaceRouting: boolean; // 启用跨命名空间路由
}
```

#### 📊 速率限制配置
```typescript
// 默认速率限制
'automix:bpm' → 250ms throttle       // BPM事件节流
'automix:energy' → 250ms throttle    // 能量事件节流
'global:performance' → 500ms throttle // 性能事件节流
'visualization:effect' → 250ms debounce // 效果事件去抖
```

---

## 🎯 智能控制算法

### 🧠 情绪驱动算法

#### 📊 情绪→随机性映射
```typescript
function mapEmotionToRandomness(energy: number, valence: number, arousal: number): RandomnessParams {
  // 能量映射: 0.2-1.0
  const energyRandomness = energy * 0.8 + 0.2;
  
  // 效价映射: 0.4-1.0
  const valenceRandomness = (valence + 1) * 0.3 + 0.4;
  
  // 激活映射: 0.2-0.8
  const arousalRandomness = arousal * 0.6 + 0.2;
  
  // 综合计算
  return {
    baseRandomness: (energyRandomness + valenceRandomness + arousalRandomness) / 3,
    emotionBias: 0.6,
    energyBias: energyRandomness,
    timeBias: 0.1,
    contrastBias: 0.2
  };
}
```

#### 🎨 预设推荐算法
```typescript
function recommendPresets(emotion: EmotionState): PresetRecommendation[] {
  const recommendations: PresetRecommendation[] = [];
  
  // 基于能量推荐
  if (emotion.energy > 0.7) {
    recommendations.push(...HIGH_ENERGY_PRESETS);
  } else if (emotion.energy < 0.3) {
    recommendations.push(...LOW_ENERGY_PRESETS);
  } else {
    recommendations.push(...MEDIUM_ENERGY_PRESETS);
  }
  
  // 基于效价推荐
  if (emotion.valence > 0.3) {
    recommendations.push(...POSITIVE_PRESETS);
  } else if (emotion.valence < -0.3) {
    recommendations.push(...NEGATIVE_PRESETS);
  }
  
  return recommendations.slice(0, 5); // 返回前5个推荐
}
```

### 🔄 自适应算法

#### 🎲 自适应种子调整
```typescript
function adjustSeedAdaptively(emotion: EmotionState, performance: PerformanceMetrics): number {
  let seedAdjustment = 0;
  
  // 基于情绪变化调整
  const emotionChange = calculateEmotionChange(emotion);
  seedAdjustment += emotionChange * 0.3;
  
  // 基于性能调整
  if (performance.fps < 30) {
    seedAdjustment -= 0.2; // 降低随机性
  }
  
  // 基于时间调整
  const timeAdjustment = Math.sin(Date.now() / 60000) * 0.1;
  seedAdjustment += timeAdjustment;
  
  return Math.max(-0.5, Math.min(0.5, seedAdjustment));
}
```

#### 🎯 性能保护算法
```typescript
function updatePerformanceGuard(performance: PerformanceMetrics): void {
  const { fps, memoryUsage, cpuUsage } = performance;
  
  // 性能下降时降低随机性
  if (fps < 30 || memoryUsage > 0.8 || cpuUsage > 0.8) {
    const reducedRandomness = MIN_RANDOMNESS_LEVEL;
    
    updateRandomnessControl({
      baseRandomness: reducedRandomness,
      emotionBias: 0.3, // 降低情绪影响
      energyBias: 0.2,
      timeBias: 0.1,
      contrastBias: 0.1
    });
  }
}
```

---

## 📊 系统监控与诊断

### 🔍 性能监控指标

#### 📈 核心性能指标
```typescript
interface PerformanceMetrics {
  fps: number;                        // 帧率
  memoryUsage: number;                // 内存使用率
  cpuUsage: number;                   // CPU使用率
  renderTime: number;                 // 渲染时间
  eventQueueLength: number;           // 事件队列长度
  presetSwitchCount: number;          // 预设切换次数
  errorCount: number;                 // 错误计数
}
```

#### 🎯 质量监控指标
```typescript
interface QualityMetrics {
  presetAccuracy: number;             // 预设推荐准确率
  randomnessQuality: number;          // 随机性质量
  emotionResponseTime: number;        // 情绪响应时间
  presetCoordinationScore: number;    // 预设协调分数
  userSatisfaction: number;           // 用户满意度
}
```

### 🚨 错误处理与恢复

#### 🔧 自动恢复机制
```typescript
interface RecoveryConfig {
  enableAutoBackup: boolean;          // 启用自动备份
  backupInterval: number;             // 备份间隔
  maxBackupCount: number;             // 最大备份数量
  enableAutoRollback: boolean;        // 启用自动回滚
  rollbackThreshold: number;          // 回滚阈值
}
```

#### 📊 故障转移策略
```typescript
interface FailoverStrategy {
  primary: string;                    // 主系统
  secondary: string;                  // 备用系统
  healthCheckInterval: number;        // 健康检查间隔
  failoverThreshold: number;          // 故障转移阈值
  recoveryTimeout: number;            // 恢复超时
}
```

---

## 🚀 扩展与优化

### 🔧 模块化扩展

#### 📦 插件系统架构
```typescript
interface PluginSystem {
  registerPlugin(plugin: Plugin): void;
  unregisterPlugin(pluginId: string): void;
  getPlugin(pluginId: string): Plugin | null;
  listPlugins(): Plugin[];
  enablePlugin(pluginId: string): void;
  disablePlugin(pluginId: string): void;
}
```

#### 🎨 自定义预设系统
```typescript
interface CustomPresetSystem {
  createPreset(config: PresetConfig): string;
  updatePreset(presetId: string, config: Partial<PresetConfig>): void;
  deletePreset(presetId: string): void;
  exportPreset(presetId: string): string;
  importPreset(presetData: string): string;
}
```

### 🎯 性能优化策略

#### ⚡ 渲染优化
```typescript
interface RenderOptimization {
  enableLOD: boolean;                 // 启用细节层次
  enableFrustumCulling: boolean;      // 启用视锥剔除
  enableOcclusionCulling: boolean;    // 启用遮挡剔除
  enableInstancing: boolean;          // 启用实例化
  enableGPUParticles: boolean;        // 启用GPU粒子
}
```

#### 🧠 AI优化
```typescript
interface AIOptimization {
  enablePredictiveLoading: boolean;   // 启用预测加载
  enableAdaptiveQuality: boolean;     // 启用自适应质量
  enableSmartCaching: boolean;        // 启用智能缓存
  enableLearningOptimization: boolean; // 启用学习优化
}
```

---

## 📚 总结与展望

### 🎯 系统优势
1. **模块化设计**: 清晰的层次结构和接口定义
2. **智能控制**: 基于情绪的智能随机性和预设推荐
3. **性能保护**: 自动性能监控和降级保护
4. **扩展性**: 插件化架构支持自定义扩展
5. **稳定性**: 完善的错误处理和恢复机制

### 🔮 发展方向
1. **深度学习**: 集成机器学习模型提升推荐准确性
2. **实时协作**: 支持多用户实时协作创作
3. **云端同步**: 云端预设库和用户偏好同步
4. **跨平台**: 支持Web、移动端、桌面端
5. **开放生态**: 第三方开发者插件生态

### 📋 下一步计划
1. **完善文档**: 补充API文档和开发指南
2. **性能测试**: 进行全面的性能基准测试
3. **用户测试**: 收集用户反馈和优化建议
4. **功能扩展**: 实现更多预设和效果类型
5. **社区建设**: 建立开发者社区和贡献指南

---

**文档版本**: v1.0  
**最后更新**: 2025-01-26  
**维护者**: AI助手  
**状态**: 已完成基础梳理，待进一步优化
